# 静态文件和媒体文件存储配置说明

## 前言

在生产环境中，正确配置静态文件和媒体文件的存储对于网站的性能、可扩展性和可靠性至关重要。本文档提供了本项目中静态文件和媒体文件存储的详细配置指南。

## 当前配置

### 前端配置

前端项目使用Vercel部署，API URL配置在`vercel.json`文件中：

```json
{
  "framework": "nextjs",
  "buildCommand": "npm run build",
  "installCommand": "npm install",
  "cleanUrls": true,
  "trailingSlash": true,
  "rewrites": [
    {
      "source": "/api/(.*)",
      "destination": "/api/$1"
    },
    {
      "source": "/(.*)",
      "destination": "/"
    }
  ],
  "env": {
    "NEXT_PUBLIC_TEMPLATE_ID": "001",
    "NEXT_PUBLIC_API_URL": "https://django-backend.onrender.com"
  },
  "functions": {
    "app/api/**/*.js": {
      "maxDuration": 30
    }
  }
}
```

`NEXT_PUBLIC_API_URL`已配置为指向部署在Render上的Django后端API。

### 后端配置

Django后端项目已配置为支持多种静态文件和媒体文件存储方式：

1. **使用S3存储（推荐用于生产环境）**：
   - 当环境变量`USE_S3`设置为`true`时启用
   - 需要配置AWS访问凭证和存储桶信息
   - 文件将存储在AWS S3上，URL通过CDN分发

2. **使用本地存储（仅开发环境）**：
   - 默认配置，适用于开发和测试
   - 文件存储在服务器本地文件系统

静态文件和媒体文件配置代码如下：

```python
# 静态文件存储配置
if os.environ.get('USE_S3') == 'true':
    # 使用AWS S3存储
    AWS_ACCESS_KEY_ID = os.environ.get('AWS_ACCESS_KEY_ID', '')
    AWS_SECRET_ACCESS_KEY = os.environ.get('AWS_SECRET_ACCESS_KEY', '')
    AWS_STORAGE_BUCKET_NAME = os.environ.get('AWS_STORAGE_BUCKET_NAME', '')
    AWS_S3_REGION_NAME = os.environ.get('AWS_S3_REGION_NAME', '')
    AWS_S3_ENDPOINT_URL = os.environ.get('AWS_S3_ENDPOINT_URL', 'https://s3.amazonaws.com')
    AWS_DEFAULT_ACL = None
    AWS_S3_OBJECT_PARAMETERS = {'CacheControl': 'max-age=86400'}
    
    # 静态文件存储
    STATICFILES_STORAGE = 'storages.backends.s3boto3.S3Boto3Storage'
    AWS_S3_BUCKET_NAME = AWS_STORAGE_BUCKET_NAME
    AWS_S3_BUCKET_REGION = AWS_S3_REGION_NAME
    
    # 媒体文件存储
    DEFAULT_FILE_STORAGE = 'storages.backends.s3boto3.S3Boto3Storage'
    
    # 媒体文件和静态文件的URL
    MEDIA_URL = f'https://{AWS_STORAGE_BUCKET_NAME}.{AWS_S3_REGION_NAME}.amazonaws.com/media/'
    STATIC_URL = f'https://{AWS_STORAGE_BUCKET_NAME}.{AWS_S3_REGION_NAME}.amazonaws.com/static/'
else:
    # 使用本地存储（仅开发环境）
    if DEBUG:
        STATICFILES_DIRS = [
            os.path.join(BASE_DIR, 'static'),
        ]
    else:
        # 生产环境部署时，使用Render提供的静态文件存储
        STATIC_ROOT = os.path.join(BASE_DIR, 'staticfiles')
    
    # 媒体文件URL配置
    MEDIA_URL = '/media/'
    # MEDIA_ROOT 在文件顶部已经定义
```

## 部署说明

### 部署到Render（推荐）

1. 确保Django项目已经部署到Render
2. 配置必要的环境变量：
   - `USE_S3=true`（如果使用S3存储）
   - `AWS_ACCESS_KEY_ID`（如果使用S3存储）
   - `AWS_SECRET_ACCESS_KEY`（如果使用S3存储）
   - `AWS_STORAGE_BUCKET_NAME`（如果使用S3存储）
   - `AWS_S3_REGION_NAME`（如果使用S3存储）

3. 更新静态文件：
   ```bash
   python manage.py collectstatic --noinput
   ```

### 使用S3存储（推荐用于生产环境）

1. 在AWS S3中创建存储桶
2. 允许公共读取访问（仅适用于需要公共访问的媒体文件）
3. 启用CORS配置，允许前端域名访问
4. 在Render项目环境变量中添加以下配置：
   - `USE_S3=true`
   - `AWS_ACCESS_KEY_ID=your_access_key`
   - `AWS_SECRET_ACCESS_KEY=your_secret_key`
   - `AWS_STORAGE_BUCKET_NAME=your_bucket_name`
   - `AWS_S3_REGION_NAME=your_region_name`

### 使用本地存储（仅开发环境）

1. Django默认使用本地存储，无需额外配置
2. 媒体文件存储在`upload`目录中
3. 静态文件存储在`static`目录中

## 文件上传功能

本系统提供多种文件上传功能：

1. **Logo图片上传**：
   - API端点：`/myapp/admin/cdn/uploadLogoImg`
   - 支持格式：.png
   - 存储位置：`upload/img/logo.png`

2. **网站图标上传**：
   - API端点：`/myapp/admin/cdn/uploadIcoImg`
   - 支持格式：.ico
   - 存储位置：`upload/img/favicon.ico`

3. **普通图片上传**：
   - API端点：`/myapp/admin/cdn/uploadImg`
   - 支持格式：.jpg, .jpeg, .png, .gif, .ico
   - 存储位置：`upload/img/{timestamp}{extension}`

4. **普通文件上传**：
   - API端点：`/myapp/admin/cdn/uploadNormalFile`
   - 支持格式：.jpg, .jpeg, .png, .docx, .pdf, .zip, .rar
   - 存储位置：`upload/files/{timestamp}{extension}`

## 注意事项

1. 确保Render项目对上传目录有写入权限
2. 对于大文件上传，可能需要调整Render的超时设置
3. 如果使用S3存储，确保CORS配置正确，允许前端域名访问
4. 静态文件和媒体文件应分离存储，静态文件可使用CDN加速
5. 建议为媒体文件添加压缩和缓存策略以提高性能

## 故障排除

1. **文件上传失败**：
   - 检查文件大小是否超过限制
   - 验证文件格式是否正确
   - 确保上传目录存在并有写入权限

2. **静态文件无法访问**：
   - 确保已运行`collectstatic`命令
   - 检查URL路径配置是否正确
   - 验证Nginx或Apache配置是否正确

3. **S3存储问题**：
   - 检查AWS凭证是否正确
   - 验证存储桶权限配置
   - 确保CORS策略配置正确

## 参考资源

1. [Django官方文档 - 静态文件](https://docs.djangoproject.com/en/4.1/howto/static-files/)
2. [Django官方文档 - 媒体文件](https://docs.djangoproject.com/en/4.1/topics/files/)
3. [Django-storages文档](https://django-storages.readthedocs.io/)
4. [AWS S3文档](https://docs.aws.amazon.com/s3/)
5. [Render部署指南](https://render.com/docs)